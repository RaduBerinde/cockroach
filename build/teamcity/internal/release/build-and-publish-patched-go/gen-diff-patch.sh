#!/usr/bin/env bash

# Copyright 2024 The Cockroach Authors.
#
# Use of this software is governed by the CockroachDB Software License
# included in the /LICENSE file.

set -euo pipefail

GOVERS=1.22.8
GO_REPO_URL="https://github.com/cockroachdb/go.git"
GO_REPO_BRANCH="origin/cockroach-go$GOVERS"
PATCH_FILE="$(pwd)/diff.patch"

GO_REPO_DIR=$(mktemp -d)
trap "rm -rf $GO_REPO_DIR" EXIT

echo "Creating a temporary clone of $GO_REPO_URL"
git clone "$GO_REPO_URL" "$GO_REPO_DIR"
echo

pushd "$GO_REPO_DIR" >/dev/null

CHANGES=$(git --no-pager log --oneline --no-decorate go$GOVERS..$GO_REPO_BRANCH)

echo "Generating patch containing the following changes:"
echo "$CHANGES" | sed 's/^/  /'
echo

cat >"$PATCH_FILE" <<EOF
# This file is generated by gen-diff-patch.sh.
# DO NOT MODIFY!
#
# To make changes, open a PR against the cockroach-go$GOVERS branch of the
# github.com/cockroachdb/go repository and run gen-diff-patch.sh after merging.
#
# This patch contains the following changes:
EOF

echo "$CHANGES" | sed 's/^/#   /' >>"$PATCH_FILE"

if git diff --no-ext-diff "go$GOVERS..$GO_REPO_BRANCH" >>"$PATCH_FILE"; then
  echo "Patch file created successfully at $PATCH_FILE"
else
  echo "Failed to create patch file."
  exit 1
fi

