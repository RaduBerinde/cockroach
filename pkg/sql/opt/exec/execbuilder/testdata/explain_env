# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U21u2zYY_h2e4oX-2B4sWbJRoJARYKrKdNpcOZCUrkUQEBRFrURlMREpT94wIIfwVXaBHSUnGShntoc5C_YR_zDA18_7fNAPbRs-8EYJWfsQSvalkZR9fvsGeMdZ3oqq4A1orjSsdyiEbBtSnEFBNc2p4nAOAwMYzFE_FkqruwrOQZblHMC2oeAlbSsNa1q13AfaatlDRV3wjjScydWK1wXVQtaK8JrmFS_-hsCYMPvh4irNcGLcZFH8DtRd5bCmyImoNW9qWjnaUJFG_kiUplooLZhyqCKyJFqseuu299uvanBSx_Zc9aTQI1Y5h8ADWZanmfaRTzEZa8oxkBXVghEmq4ozcxnO4S4GJa0UP82um5b_G_aVqM297G5IGZFXpwVeue4z_KVsOKNKq__PstoozVek_wsVMQF2838ggK5S3Jd3jsIEBxmGLHizwHDb5pVgTgdDdEYhirPXEC8ziK8WizE6yx8nu1O4jNMsCaI4g47cfuEbuEyi90HyCb7Dn2BIIUjD0RidRfFb_BE6khNRdDDM-zkazREKFibgTtmYcfbyUfwtDjNIsyCL0iwKUxhcIwCAn_tv87Ho-geixE_c8sEdH8ZMVu2qVpYP1_vhDm_tzzfH-IZTzQtCteWDNXW917br2a4Hrue7ru-61hHYVFrUTBMm29oseO6x9mehtDRFInpza4xZx8t1W1X7xeM18wz3hNOZN531v_0y_q-R8xeJ3Dt8udToZjB_rqAbU9D2LwVdP1XQzYmCtn8U9E-4NSkN8mKZ4OhdvEOuR5DgC5zgOMTp_o0M6aHdZq9v9_r5dm9OtrsPjT9eLoIohuHyMhsDjj-MIMULg_0KLpLle-jg-29wgiGHc5jNkW3bNlKM1tB9_fjAEDxstw_b-4ftPTBZK91QUWsfJtOJ58P1ZAY2TGY36PcAAAD__73J-io=


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VO1u2zYU_R0-xYX_2B5MR4pRoJARYK7KdNpcOZCUrkUQEBRFrVxlMhUpT9owoNgz-OdeYy-wR8mTDJQzx0PdBfuofxjg5bn3nHN9aIzhlaiN1CqAUPN3tWb87fNnIFrB80ZWhajBCmNhs0MhhDGkJIOCWZYzI-Achg4wnKO-LI017ys4B12WcwCMoRAlayoLG1Y1IgDWWN1DpSpES2vB9XotVMGs1MpQoVheieJvBjgRrj9cXqUZSZyaLIpfgHlfTXld5FQqK2rFqql1o2itf6DGMiuNldxMmaG6pFaue-nY__03MzzKg33PfJLoHmumD4aHuiyPT9pbPjbJSTNTB1kzKznluqoEd8uYPuxiWLLKiOPTbd2IfzN9LZXby25DxpE8OU7wxPMemV_qWnBmrPn_JJvOWLGm_U9oqDOwq_8DAnSVkj68cxQmZJERyBbPlgRum7ySfNrCCJ0wiOLsKcSrDOKr5XKCTvL7yu4UruI0SxZRnEFLb9-JDi6T6OUieQPfkDcwYrBIw_EEnUTxc_IaWppTWbQwyvs6Gs8RWiydwR2zEzPd00fx1yTMIM0WWZRmUZjC8BoBAPzUf7vPgG2-o0b-KAYBeJOHMtdVs1ZmEMD1vrjDD_bnm0N8LZgVBWV2EMDgzPOfYs_Hng-eH3he4HmDA7CLtFTcUq4b5Rp875D7rTRWuyBR2906YYPDZtVU1b7xsM09w_3As5l_Nuvvfp78V8v5Z7HcK_x8rtHNcP5YQDsX0OajgG4-FdDuSECbPwP6F9yGlg55sUpI9CLeITdjSMgFSUgcknT_RkbsId2ur0_35vF0d0fT3Zsmry-XiyiG0eoymwCJX40hJUuH_QIuktVLaCfQwbdfkYRADucwmyOMMUZSKVHj77VUMOK1NmaM4G776932w932AxjOFHQfVdov79-ku_nFrf5uu70HcK2MrZlUNoDTs1M_gOvTGWA4nd2gA1gpKytqAyP3pzJGfwQAAP__l4MeQg==

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4kA3tgdLkFIUKGzkQlWZQpsrB5JStAgCgqKolatMJiLlyBsG5CF8udfYC-xR8iQDpcz2MGfBfuILwzr8zvm-7_ijXBc-8kYLJWcQKfa1UZR9efcWeMdZ0Yq65A0Yrg2sBxRCrgsZzqGkhhZUcziDkQWM5qgvC230bQ1noKpqDuC6UPKKtrWBNa1bPgPaGtVDhSx5RxrO1GrFZUmNUFITLmlR8_JvBlgRtj9aXGY5Tq2aPE7eg76tPdaUBRHS8EbS2jN2FGnUHdGGGqGNYNqjmqiKGLHqpbvBb7_q0VEeN_D1k0SPWO3tDY9UVR2ftLN8bJKVpj0LWVEjGGGqrjmzy_D2uxhVtNb8-HTTtPzfTF8JafcybEhbktfHCV77_jPzK9VwRrXR_59kvdGGr0j_F2piDQz1f0CALjPch3eOohSHOYY8fLvAcNMWtWBeB2N0QiFO8jeQLHNILheLKTopHivDU7RMsjwN4ySHjtx85Ru4SOMPYfoZvsOfYUwhzKLJFJ3EyTv8CTpSEFF2MC76OprMEQoX1uDAbMV4O_o4-RZHOWR5mMdZHkcZjK4QAMBP_bf9OHT9PdHiR-7MwJ_uy0zV7UpqZwZXu-KAd3bP14f4hlPDS0KNMwPn1A_euH7g-gH4wcz3Z77vHIBtpIVkhjDVStsQ-IfcX4Q2ygaJmM2NFeYcNsu2rneNh232Gu4Gnr4KTl_1Zz9P_6vl4kUs9wpfzjW6Hs2fC-jGBrT9S0DXTwV0cySg7R8B_RNuTSqLPF-mOH6fDMj1BFJ8jlOcRDjb3ZEx3afb9vXpXj-f7s3RdPem8aeLRRgnMF5e5FPAyccJZHhhsd_Aebr8AB2EGSjJp8Mvc6fmyHVdFwkpeeP-oISEMWuU1hMED9tfHrb3D9t70IxK6OCK6jMl-fUTR-ZO9Ufbx6NK1IY3Gsb2lTFBvwcAAP__jxISrQ==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgZLkWJ0CGTkQVWZTpsrB5LStQgCgqKolatEpiLlWRsG9CPyK_uBfUq-ZKDcOR6mLtjW6EEAr865556rQ8eB17zVQskAIsXet4qydy-eA99yVnSiLnkLhmsDmx0KIceBDOdQUkMLqjmcw9QCpks0lIU2-kMN56CqagngOFDyina1gQ2tOx4A7YwaoEKWfEtazlTTcFlSI5TUhEta1Lz8hwZKDvSWq7bkLflRCalJLRph4By-XoxyztDAiVZXWY5TayCPk5egP9Qua8uCCGl4K2ntGqtOWvUT0YYaoY1g2qWaqIoY0QxuHf_33_R0VMbxPf1ZoU9Y7T7saKqqarzTfktjnexo2rWQhhrBCFN1zZndn_uwvmlFa83Hu5u24_-leyOk3ctuQ9qKPBsXeOZ5j_SvVMsZ1UZ_uZF1rw1vyPALNbEGdvV_IYCuMjzkfYmiFIc5hjx8vsJw2xW1YO4WZuiIQpzkZ5Csc0iuVqs5Oio-VXanaJ1keRrGSQ5bcvue93CZxq_C9C18h9_CjEKYRcdzdBQnL_Ab2JKCiHILs2Koo-MlQuHKGtwp22HcvXycfIujHLI8zOMsj6MMptcIAOCX4W2fCd38QLT4mU8C8OYPZabqrpF6EsD1vrjDT_bnm0N8y6nhJaFmEsDk1PPPHM93PB88P_C8wPMmB2AbaSGZIUx10hJ871D7ndBG2SAR09_awSaHZNnV9Z54SLPXcN_wdOGfLoZvv87_r-XiSSwPEz6da3QzXT4W0N4GtPtbQDefC2g_EtDuz4D-BbchlUVerFMcv0x2yM0xpPgCpziJcLa_IzP6kG7LG9K9eTzd_Wi6B9P4zeUqjBOYrS_zOeDk9TFkeGWxX8FFun4FPXz_DU4xdHAOiyVyHMdBmlEJPYL7u7v7u4_3dx-BKalNS4U0AZz4AVyfLMCBk8UN-iMAAP__fhsHaA==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYUvg6f4sA3dgbLkWK0CGTkQlWZTpsrB5LStQgCgqKolatEpiLlWRsG9CHyKnuBPUqeZKDc2R6mNNjW-MKAjr4ffkcfHQfe8EYLJX0IFfvQKMrev3wBfMNZ3oqq4A0Yrg2styiEHAdSnEFBDc2p5nAOYwsYL1A_FtrojxWcgyrLBYDjQMFL2lYG1rRquQ-0NaqHClnwDWk4U3XNZUGNUFITLmle8eILAkr29IarpuAN-UkJqUklamHgHJ7PBzlnqOeEy6s0w4kNkEXxK9AfqxlripwIaXgjaTUz1p006meiDTVCG8H0jGqiSmJE3ad1vD9-1-NBG8dz9YNGn7F6tt_RWJXlsNJuS19UGt7B-Pl8WPTsQUUbVs-saU2NYISpquLMfpHZ_oOMS1ppPixtmpb_F_VaSLvp7c61NXk2bPDMdR_RL1XDGdVGf70j604bXpO-FJrYANv5vzBAVynub9AChQkOMgxZ8GKJ4bbNK8FmG5igIwpRnJ1BvMogvloup-go_zzZPoWrOM2SIIoz2JDbD7yDyyR6HSTv4Hv8DiYUgjQ8nqKjKH6J38KG5EQUG5jk_RwdLxAKljbg1tkeZrazj-LvcJhBmgVZlGZRmML4GgEA_Nr_29-Irn8kWvzCRz640_2YqaqtpR75cL0bbvGj3fPNIb7h1PCCUDPyYXTqemeO6zmuB67nu67vuqMDsL0kQjJDmGqlJXjuofd7oY2yRSKmu7UHGx2SZVtVO-IhzV7sneDp3Dud9-9-m_7fyPmTRO5P-HSp0c148VhBO1vQ9h8FXT9U0G6goO1fBf0bbk1Ki7xYJTh6FW-R62NI8AVOcBzidHdHJnTfbsvr271-vN3dYLv70Pjt5TKIYpisLrMp4PjNMaR4abHfwEWyeg0d_PAtTjC0cA7zBXIcx0GaUQkdgvu7u_u7T_d3n4ApqU1DhTQ-nHg-XJ_MwYGT-Q36MwAA___jByHS

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYUvg6f4sA3dgbLkWK0CGTkwnWZTpsrB5LStQgCgqKolKtMpiLlWRkG9CHyKnuBPUqeZCDVOR6mNNjW-sKAjr4ffkcfPQ_e8FoLJUNYKPahVpS9f_kC-JazvBFVwWswXBvYdCiEPA9SnEFBDc2p5nAKQwsYzpAbC230xwpOQZXlDMDzoOAlbSoDG1o1PATaGOWgXNK84uRWXN_Sa_KzEtKyZC9JlaXjCFnwLak5U-s1lwU1QklNOqXiC6ZKOnrNVV3w2plpUom1MHAKz6e9nBPkOIvlRZrhxIbOovgV6I_VhNVFToQ0vJa0mhiXo1a_EG2oEdoIpidUE1USI9ZuQ17wx-962GvjBb5-1OgzVk8e9jpUZdmvtNvsF5X6dzB8Pu0XPXlU0YbVE2u6pkYwwlRVcWa_yOThgwxLWmneL23qhv8X9bWQdtPdzrU1edZv8Mz3n9AvVc0Z1UZ_vSPrVhu-Jq4UmtgA3fxfGKCLFLtbN0OLBM8zDNn8xRLDTZNXgk22MEIHFKI4O4F4lUF8sVyO0UH-edI9LVZxmiXzKM5gS24-8BbOk-j1PHkHP-J3MKIwTxeHY3QQxS_xW9iSnIhiC6PczdHhDKH50gbsnO1hJjv7KP4BLzJIs3kWpVm0SGF4iQAAfnX_9jegm2uixS0fhOCPH8ZMVc1a6kEIl7thhx_snq_28TWnhheEmkEIg2M_OPH8wPMD8IPQ90PfH-yB7SURkhnCVCMtIfD3vd8LbZQtEjHtjT3YYJ8sm6raEfdp9mLvBI-nwfHUvftt_H8j598ksjvht0uNroazpwra2oI2_yjo5rGCtj0Fbf4q6N9wG1Ja5NkqwdGruENuDiHBZzjB8QKnuzsyog_ttjzX7s3T7W572-1C47fny3kUw2h1no0Bx28OIcVLi_0OzpLVa2jhp-9xgqGBU5jOkOd5HtKMSmgR3N_d3d99ur_7BExJbWoqpAnhKAjh8mgKHhxNr9CfAQAA__8VuDNP

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3cgbLkWK0CGTkwnWZTpsrB5LStQgCgpKolKtEpiTl2RkG9CHyKnuBPUqeZCDdOR6mNNjW-sIAj78fnnM-2vfhDVOaSxHBXJYflKTl-5cvgK1ZWXS8qZgCw7SB1RaFkO9DhnOoqKEF1QxOwbMAb4pcmWujPzZwCrKupwC-DxWradcYWNGmYxHQzkgHZYIWDSO3_PqWXpOfJReWJXpJsq4dh4uKrYlipWxbJipquBSabJWqL5hK4ejyxvCW3zJFOs3Ie66NvFa01U8zFZOqYspdU5OGt9zAKTyf9HJOkOPMFxdZjlM7rjxOXoH-2IxLVRWEC8OUoM3YuAko-QvRhhquDS_1mGoia2J462brh3_8rr1eGz8M9KNGn7F6_LART9Z1v9JuJ19U6p-B93zSL3ryqKJtVo-taUsNL0kpm4aVdpfjh1V6NW0065c2qmP_Rb3lwk56O3O7de9Zv8GzIHhCv5aKlVQb_fWurDfasJa4UGhiG9jW_4UBusiwe69TNE_xLMeQz14sMNx0RcPL8RqG6IBCnOQnkCxzSC4WixE6KD5Xtqf5MsnydBYnOazJzQe2gfM0fj1L38GP-B0MKcyy-eEIHcTJS_wW1qQgvFrDsHB1dDhFaLawDW6d7WXGO_s4-QHPc8jyWR5neTzPwLtEAAC_um_7GdDVNdH8lg0iCEYP5VI2XSv0IILLXXGLH-zOV_t4xahhFaFmEMHgOAhP_CD0gxCCMAqCKAgGe2D7SLgoDSllJywhDPa93T-FDRIxmxt7scE-WXRNsyPu0-zD3gkeT8Ljifvtt9H_bbn4Ji27G367rtGVN30qoBsb0O4fAV09FtBNT0C7vwL6N9yK1BZ5tkxx_CrZIleHkOIznOJkjrPdGxnSh3Rbnkv36ul0b3rT7ZrGb88XsziB4fI8HwFO3hxChhcW-x2cpcvXsIGfvscphg5OYTJFvu_7SJdUwAbB_d3d_d2n-7tPUEqhjaJcmAiOwggujybgw9HkCv0ZAAD__w0BR5o=

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN9u2zYXvw6f4sA3cj5YjhSjRSAjF67L9NPmyoGkdC2CgKAkKuVKkalIeXaGAX2IvMpeYI-SJxlId46HKc26rb4wwOPfn3MOf7TvwxvWaq5kBHNVfmgVLd-_fAFszcqi46JiLRimDay2KIR8HzKcQ0UNLahmcAqeBXhT5MpcG_1RwCmoup4C-D5UrKadMLCiomMR0M4oB2WSFoKRW359S6_Jj4pLy5K9JFXXjsNlxdakZaVqGiYrariSmmyVqi-YKuno6sbwht-ylnSakfdcG3Xd0kZ_LbPphOGlEkQbav4Gu2WqrVjrhtRE8IYbOIXnk17OCXKc-eIiy3Fql53HySvQH8W4bKuCcGlYK6kYG7e_Vv3k2uDa8FKPqSaqJoY37mb88Ldftddr44eBftToM1aPH-7TU3Xdr7S70S8q9e_Aez7pFz15VNHtfGxNG2p4SUolBCttEsYPQfBqKjTrlzZtx_6JesOl3fR25_bWvWf9Bs-C4An9WrWspNro_65lvdGGNcSFQhM7wLb-FQboIsPutU_RPMWzHEM-e7HAcNMVgpfjNQzRAYU4yU8gWeaQXCwWI3RQfK5sT_NlkuXpLE5yWJObD2wD52n8epa-g-_xOxhSmGXzwxE6iJOX-C2sSUF4tYZh4erocIrQbGEH3DrbZsY7-zj5Ds9zyPJZHmd5PM_Au0QAAD-7b_sZ0NU10fyWDSIIRg_lUomukXoQweWuuMUPduerfXzLqGEVoWYQweA4CE_8IPSDEIIwCoIoCAZ7YPtIuCwNKVUnLSEM9r3d_4wNEjGbG9vYYJ8sOyF2xH2afdg7weNJeDxxv_0y-rcjF99kZNfht5saXXnTpwK6sQHt_hLQ1WMB3fQEtPsjoH_CrUhtkWfLFMevki1ydQgpPsMpTuY4272RIX1It-W5dK-eTvemN91uaPz2fDGLExguz_MR4OTNIWR4YbH_g7N0-Ro28MP_cYqhg1OYTJHv-z7SJZWwQXB_d3d_9-n-7hOUSmrTUi5NBEdhBJdHE_DhaHKFfg8AAP__6WZdmw==

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysk9Fu0zAUhu_zFOcugHDUrnQtq3pRgkGV2mw0abU7y3VOhMGxqY8zxoPxAjwZcorYTTYE4i5y_vP9-f8TMwYH9KSdvYLcqc_eSfXx7RvAe1THTpsaPQSkAHdnVZIwBiWvoJZBHiUhLCGNgnSR9MeaAp0MLME1zQKAMaixkZ0JcCdNh1cgu-B6qbY13guPyrUt2loG7SwJtPJosH4C4Gw_7tH5Gr345LQlYXSrAyzhcjI4M0_6mXyzLyu-iwGqdfEe6GQy5euj0Dagt9JkIboL774KCjJoClpRJkm4RgTd9mnZ-Md3Sgdt2HhEjxr90lL20FHqmmaY9LulJ0nDHaSXk2Ho_FFiDEtZNG1l0EooZwyquJHsYSFpIw3hMDr4Dv-F3mobmz53TtFkOmwwHY3-wG-cRyUp0P_7ZPpGAVvR_xQkYoDz-V8YJPuS9zdokeQ7vqo4lPzDnhc5hy_d0WiVEZ5guy4Oq82ewxi2q9vz4-uLi8lkdjGaXM6nr2az6Xw0g3WR7_iWFxWMoaxWuwrGiyThtzeb1bqAZ9c31UvgxeE5lHzD8wpewLvd9RYIT4uEMcYSwlOHViEjjCuIb5KfAQAA___9p0wT

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfJkWO0CGQEmOoynTZXDiQlbREEBCVRK1eZTElKszcMKPYNftxv7Af2KfmSgXLiuKvSYFvrBwO6Ovccnstz5bpwwZTmUvgwk_k7JWn-9vkzYCuWZzWvCqbAMG2g2aIQcl1IcAoFNTSjmsEJ9C2gP0VtmWuj31dwArIspwCuCwUraV0ZaGhVMx9obWQL5aJgK6JYLpdLJgpquBSaMEGzihWfIZCibVdMqoIp8pPkQpOKL7mBE3g66ew5Rm3PbH6epDi2BtIwegH6fTXKVZERLgxTglYjY9WJkj8Tbajh2vBcj6gmsiSGL1u37vivP3W_U8Yde_pBoVusHt3PqC_LsptpN6XPMnXPoP900k16_CCjNatHVnRJDc9JLquK5fZGRvcX0i9ppVk3tVE1-y_sSy7spLcz11bkSbfAE897hL-UiuVUG_3ljqzX2rAlaUOhiTWwrf8LAXSe4HaDpmgW4yDFkAbP5hiu66zi-WgFA3RAIYzSY4gWKUTn87mDDrLbyvZptoiSNA7CKIUVuX7H1nAWhy-D-A38gN_AgEKQzIYOOgij5_g1rEhGeLGCQdbW0XCKUDC3BrfK9jCjnXwYfY9nKSRpkIZJGs4S6F8iAIBf23_769HmR6L5L6zng-fcl3NZ1Uuhez5c7opbfG_3fLWPV4waVhBqej70jrzxseuNXW8M3tj3PN_zentguyRc5Ibksha2Yezta7_l2kgbJGLW1_Zgvf1mUVfVrnG_zS72jvBoMj6atO9-c_6v5eyrWG5P-PVco6v-9LGArm1A608C2jwU0HVHQOu7gH6Ea0hpkaeLGIcvoi2yGUKMT3GMoxlOdjsyoPfptn1tupvH073uTHe36YsQv7oTbNqltGvooIPaukVDCBJI8NyyUQcyB2oHGjiNFy8_XijnHyd49R2OMWRwApMpQvj12TwIIxgszlIHcHQxvCP9ZsvVTJHrui7iQjDl2u86DHIltR4iuNn8cbP5cLP5ADqnAtafVFbf3u6-ffO7veKbzeYWkEuhjaJcGB8Ojw7HPlweTsCFw8kV2oOVvDJMaRjYj9cQ_R0AAP__2khmVg==

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk9Fu0zAUhq_npzh3adEcdZo2VYt6kYWAAllaJe7EhJDlJifCLImZjzu2B-MFeDLkFLGbbAjErfWf7z__fxLO4RotaTNcQGLqW2tU_fn1JeAD1ru97hq04JAc3B9UjHEOVSqgUU7tFCGsIPCCIGLjsyZHdx2swLRtBMA5NNiqfefgXnV7vAC1d2aU6qHBB2mxNn2PQ6OcNgNJHNSuw-YFgBnGcYvGNmjlF6MHkp3utYMVnJ9OzizZOJPk20qkpQ8gsuIt0F0X1rbZST04tIPqQufdpTXfJDnlNDldU6hImlY63Y9p-cmP7xRM2vCTBT1r9EtL4VNHgWnbadLvll4kTXcQnJ9OQ5fPEn1YCr1pr5yuZW26Dmt_kfDpIEGrOsJptLN7_Bd6rwff9KFz8iZn0wZni8Uf-K2xWCty9P9Wpkdy2MvxoyDpAxze_8KAbat0_IMilpRpLFIQ8WWeAoUOZuxIQVaIJRRrAcU2z4_ZUbIuKlHGWSHAya-3-AibMruKyxt4n97ATEFcJXM2jxiLc7_1AecdQs_MindpIqASscgqkSUVBB8_BRFj6YdNHmcFzNYbcQxpcT2HKs299hW8KddXfqOIcc45o1oN4NjPAAAA__8OLFCp

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zwQhfc6xexkA6FgI0gQxPAif36hCGC4Qe0Y3REjapSyoUiYM3KTXQ7hq_QCPYpPUlBum42SokW3xHvfEz9RKdhQZBv8JVwH8xADmk___wf0SKbqrKspghAL7I6pLFMKVuUaahSskAnmkKdAPsv6Y2qwc6Ilomc0YoPX2w6dlScdGs0Ud9akUoXm4T6GztczAKV-FmGHrqNLiHTfOYxHpmXhrYM5hKYZTGMnoY9aX9OjjmRC25KvMe2zJo-Vo_oNQPB9PVKINUX9OVjP2tnWCszh_HSwc5H1nevF3WpdfkhS1jfLd8BbV5hYV9p6oejRFZLWdQxfNAuKZbGGC-TkQ2zbG1TTb185H5xR0wm_OvQjy8WLozw0zTDpl6U3ScMO8vPTYejFq8R0WS7SaItijTbBOepfRPHyQ_IGHdMwWmJHf0NvrU-mj845jZwND5xNJr_hNyGSQRb-d5_MTyzU6v5RsE4XOJ7_wUBWfrxdXN0sYfT-dn0C5XIzhs3V4q5cwWg6nmVKKZX1Bc7gsN8f9s-H_TOMpifj7HsAAAD__yAgUKM=

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFqGzEUhvc6xduNDdFgExJCjBdpakrAuKF2THfiWfOmVauRsN4bN9nlEL5KL9Cj-CRF47bZTFJashX___2jb6Q1rCmxi-ESrqP9miLaz2_fAN2T3bTOV5RAiAV2x5RSWsNytoIKBTfIBFMocqCYqO6Yamy9GEkYGK24GMy2Re_kwcTaMKWds7lkkxNn0U8AtP5dgx36li4h0afWYzoSHQtvPUwh1nVvGluJXdSFiu5NIhubhkKFeZ0NBdx4ql4AxNDVE8VUUTJfogtsvGucwBTOT3s7F6rrXM_vlqvZh6xkdbN4B7z1pU3VxrgglAL6UvK6SfGbYUFxLM5yiZxtiGs6f3r84zsXvTN6POJnh35luXxyVMS67if9sfQiqd9BcX7aD714lpgvy2UebVCcNTZ6T917KJ9-SFGjZ-pHS2rpf-iNC9n00TnnkbP-gbPR6C_8OiayyMKv98n8wEKN6R4Fm3yB4_k_DKjZx9v51c0CBu9vVycwW6yHsL6a382WMBgPJ0prrVVXYAWH_f6wfzzsH2EwPhmqnwEAAP__6QxPzg==

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U92O2jgUvh4_xRE3MCuCwoxajUBzQamnyi4NoyRTtaoqy3Gc1ouxGdthCat9rH2BfbKVk5ahapjZn5YLJB--H3-Hz0EAb7ixQqsJzDVbGU3Zp5cvgO84yyshC27Acetg26IQCgJIcQYFdTSnlsM19D2gP0XNmJe0ko44Q5WlzAmtyH1FpXA10SWx3GwF8yRmhBOMyilAEHyhwZbKik_A8I-VpKZVFNbZewnXoMuyE00rpxuoUAXfEcOZXq-5Kqh3t4QrmktePCKgVUM3XJuCG_KrFsoSKdbCwTU8v-zkXKGGM1_cpRlO_EqyKH4F9l6OmClyIpTjRlE5ct6dGP0bsY46YZ1gdkSt34YT62Z_wfivP22_0yYYh_ak0WesHT3sqK_LslvpsKVHlbp30H9-2S16dVLRh7Ujb7qmTjDCtJS86cPo4Q_pl1Ra3i3tTMX_i_paKL_pdufWmzzrNngWhk_ol9pwRq2z3-_KtraOr0lTCkt8gHb-LwzQXYqbNzlF8wTPMgzZ7MUCw6bKpWCjHQzQGYUozq4gXmYQ3y0WQ3SWf560p_kyTrNkFsUZ7MhmxWu4TaLXs-Qd_ILfwYDCLJ2fD9FZFL_Eb2FHciKKHQzyZo7OpwjNFj5g6-wvMzrYR_HPeJ5Bms2yKM2ieQr99wgA4Pfm2396dPuRWLHnvQmEw4cx07JaK9ubwPvDsMX3DucPx3jDqeMFoa43gd5FOL4KwnEQjiEcT8JwEoa9I7B_JEIxR5iulCeMw2PvT8I67YtEXL3xF-sdk1Ul5YF4TPMP-yB4cTm-uGx--2P4fyPnPyRyc8Mflxp96E-fKmjtC1p9U9DtqYLWHQWtvhT0K9yWlB55s0xw9CpukdtzSPANTnA8x-nhjQzoQ7s9r2n39ul2153t_geh9z70ZvVNasPLU7n3Hbk3q47g5erryIaXXaHrQfV4uP3pcPjt7WIWxTBY3mZDwPGbc0jxwmN_gptk-Rr2UxQEQYAsowr26O8AAAD__y2LbPs=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U92O2jgUvh4_xRE3MCuCwoxajUBzQamnyi4NoyRTtaoqy3Gc1ouxGdthyaz2sfYF9slWTlqgapjZn5YLJB--H3-Hz0EAb7ixQqsJzDVbGU3Zp5cvgO84yyshC27Acetg26IQCgJIcQYFdTSnlsM19D2gP0XNmJe0ko44Q5WlzAmtyH1FpXA10SWx3GwF8yRmhBOMyilAEHyhwZbKik_A8I-VpKZVFNbZewnXoMuyE00rpxuoUAXfEcOZXq-5Kqh3t4QrmktePCKgVUM3XJuCG_KrFsoSKdbCwTU8v-zkXKGGM1_cpRlO_EqyKH4F9l6OmClyIpTjRlE5ct6dGP0bsY46YZ1gdkSt34YT62Z_wfivP22_0yYYh_ak0WesHR121Ndl2a2039KjSt076D-_7Ba9Oqnow9qRN11TJxhhWkre9GF0-EP6JZWWd0s7U_H_or4Wym-63bn1Js-6DZ6F4RP6pTacUevs97uyra3ja9KUwhIfoJ3_CwN0l-LmTU7RPMGzDEM2e7HAsKlyKdhoBwN0RiGKsyuIlxnEd4vFEJ3lnyftab6M0yyZRXEGO7JZ8Rpuk-j1LHkHv-B3MKAwS-fnQ3QWxS_xW9iRnIhiB4O8maPzKUKzhQ_YOvvLjPb2UfwznmeQZrMsSrNonkL_PQIA-L359p8e3X4kVjzw3gTC4WHMtKzWyvYm8H4_bPG9_fnDMd5w6nhBqOtNoHcRjq-CcByEYwjHkzCchGHvCOwfiVDMEaYr5Qnj8Nj7k7BO-yIRV2_8xXrHZFVJuSce0_zD3gteXI4vLpvf_hj-38j5D4nc3PDHpUYf-tOnClr7glbfFHR7qqB1R0GrLwX9CrclpUfeLBMcvYpb5PYcEnyDExzPcbp_IwN6aLfnNe3ePt3uurPd_yD0gw-9WX2T2vDyVO6HjtybVUfwcvV1ZMPLrtD1oHo83MPpcPjt7WIWxTBY3mZDwPGbc0jxwmN_gptk-RrqKQqCIECWUQU1-jsAAP__LXps-Q==

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U92O2jgUvh4_xRE3MCuCwoxajUBzQamnyi4NoyRTtaoqy3Gc1ouxGdthyaz2sfYF9slWTlqgapjZn5YLJB--H3-Hz0EAb7ixQqsJzDVbGU3Zp5cvgO84yyshC27Acetg26IQCgJIcQYFdTSnlsM19D2gP0XNmJe0ko44Q5WlzAmtyH1FpXA10SWx3GwF8yRmhBOMyilAEHyhwZbKik_A8I-VpKZVFNbZewnXoMuyE00rpxuoUAXfEcOZXq-5Kqh3t4QrmktePCKgVUM3XJuCG_KrFsoSKdbCwTU8v-zkXKGGM1_cpRlO_EqyKH4F9l6OmClyIpTjRlE5ct6dGP0bsY46YZ1gdkSt34YT62Z_wfivP22_0yYYh_ak0WesHR121Ndl2a2039KjSt076D-_7Ba9Oqnow9qRN11TJxhhWkre9GF0-EP6JZWWd0s7U_H_or4Wym-63bn1Js-6DZ6F4RP6pTacUevs97uyra3ja9KUwhIfoJ3_CwN0l-LmTU7RPMGzDEM2e7HAsKlyKdhoBwN0RiGKsyuIlxnEd4vFEJ3lnyftab6M0yyZRXEGO7JZ8Rpuk-j1LHkHv-B3MKAwS-fnQ3QWxS_xW9iRnIhiB4O8maPzKUKzhQ_YOvvLjPb2UfwznmeQZrMsSrNonkL_PQIA-L359p8e3X4kVjzw3gTC4WHMtKzWyvYm8H4_bPG9_fnDMd5w6nhBqOtNoHcRjq-CcByEYwjHkzCchGHvCOwfiVDMEaYr5Qnj8Nj7k7BO-yIRV2_8xXrHZFVJuSce0_zD3gteXI4vLpvf_hj-38j5D4nc3PDHpUYf-tOnClr7glbfFHR7qqB1R0GrLwX9CrclpUfeLBMcvYpb5PYcEnyDExzPcbp_IwN6aLfnNe3ePt3uurPd_yD0gw-9WX2T2vDyVO6HjtybVUfwcvV1ZMPLrtD1oHo83MPpcPjt7WIWxTBY3mZDwPGbc0jxwmN_gptk-Rp2UxQEQYAsowp26O8AAAD__y1pbPc=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U-1u2zYU_R0-xYX_2BksQ07QIrCRH67LFNpcOZCUokVREBRFtZxp0iEpz_Kwx9oL7MkGSo3joXKyr_qHAV6fe889x-cGAbzjxgqtJjDXbGU0ZV9evwK-4yyvhCy4Acetg22LQigIIMUZFNTRnFoO19D3gP4UNWVe0ko64gxVljIntCL3FZXC1USXxHKzFcw3MSOcYFROAYLgoQ22VFZ8AoZ_riQ17URhnb2XcA26LDvRtHK6gQpV8B0xnOn1mquCenZLuKK55MUTA7Rq2g3XpuCG_KyFskSKtXBwDS8vO3uuUNMzX9ylGU68JVkUvwF7L0fMFDkRynGjqBw5z06M_oVYR52wTjA7ota74cS68S8Y__G77XfSBOPQniT6irWjR4_6uiy7Jx1cenJStwf9l5fdQ69OTvRi7ciTrqkTjDAtJW_yMHr8Q_ollZZ3j3am4v9m-loo73TrufUkL7oJXoThM_NLbTij1tn_b2VbW8fXpAmFJV5AW_8HBOguxc1NTtE8wbMMQzZ7tcCwqXIp2GgHA3RGIYqzK4iXGcR3i8UQneVfK-1rvozTLJlFcQY7slnxGm6T6O0s-QA_4Q8woDBL5-dDdBbFr_F72JGciGIHg7ypo_MpQrOFF9gy-2VGB_oo_hHPM0izWRalWTRPof8RAQD82nz7T49uPxMr9rw3gXD4WGZaVmtlexP4eCi2-N7h_ekYbzh1vCDU9SbQuwjHV0E4DsIxhONJGE7CsHcE9kciFHOE6Ur5hnF4zP1FWKd9kIirN36x3nGzqqQ8NB63-cM-DLy4HF9cNr_9NvyvkvPvIrnZ8PupRp_60-cCuvcB3ay-Sajh5amM7jsyulk9hPQIWK7gZpng6E3cggwvzyHBNzjB8RynDyvUg-rpFO87U_w3xNVeXPWNtu0pZXWHsqpDWE22pPTIv8jbdonbDegzrnS27Qeb1ePJe77m5LfPn3x92iz8_nYxi2IYLG-zIeD43TmkeOGxP8BNsnwL9RQFQRAgy6iCGv0ZAAD__xDtfL0=

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy8VN1u2zYUvg6f4sA3cgZLkJWmS23kQnHUQZsqB5YStCgKgqKolitFJiSVJhv2WHuBPdlAunE8QMl-sM0XBvyd7-foI-UwhCumDVdyAStFP2tF6KfzM2B3jDYDFy3TYJmxcLtlIRSGUGU1tMSShhgGpxA4QrBEHmYdGYTFVhNpCLVcSXwzEMHtPVYdNkzfcupEVHPLKRFLgDB8kMEtEQNbgGYfB0H01pEba24EnILqulE2GazyVC5bdoc1o6rvmWyJSzeYSdII1j5joKSXa6Z0yzT-UXFpsOA9t3AKL49GNSfIa1bFZVVnG1dJnZffgbkREdVtg7m0TEsiIuvSsVZfsLHEcmM5NRExrg3Le99fOP_tVxOMxoTz2DwZ9JVroseOAtV14067lp51Gu8geHk0bnrypKN7WBO50J5YTjFVQjB_H6LHAwk6Igwbt7Z6YP_EvefSNb3t3LiQ4_GA4zj-E_9OaUaJsebfW9ncG8t67C-Fwe4BtvjfCECXVebfySVabbK0zqBOz4oMrodGcBo1MEUHDZyt1wWU6xrKy6KYoQOtvvAW8rI-8ehVXuVO9MCA8-x1elnUMEh-M_jueDs9nKGD1bqs6k2alzU0-Pozu4eLTf4m3byDH7J3MN36ptXKcfPyPHsLDW4wb-9g2ngcHS4RSgvXx3ZRt3u02zYvv89WNVR1WudVna8qCN4jAICf_bf7TMjtR2z4T2yygPnsEaZKDL00kwW834F-0Ex2vz_s8zUjlrWY2MkCJkmcJOE8CeME5ieLoxeL5FV0_O2LV0fJZE_jXi0uqcVUDdLpkr3hJ26scpcP2_trt91kXypJ7zHszxnjP8wGIXaW8d7A_VE84PN5HPvJL7NnGon_SiP-mP7DVuL_r5WvlaAPwRKh7O1FkeYlTNcX9Qyy8uoQqqxwF-obeL1Zv4FmicIwDJGhREKDfg8AAP__EoQKSQ==
