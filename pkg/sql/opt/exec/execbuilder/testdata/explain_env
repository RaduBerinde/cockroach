# LogicTest: local !metamorphic-batch-sizes
# We must turn off metamorphic variables because some are included in
# EXPLAIN (OPT, ENV) output.

statement ok
CREATE TABLE x (
  a INT PRIMARY KEY,
  b INT,
  INDEX (b),
  FAMILY "primary" (a, b)
)

statement ok
ALTER TABLE x INJECT STATISTICS '[
  {
    "columns": ["a"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 100,
    "histo_col_type": ""
  },
  {
    "columns": ["b"],
    "created_at": "2018-01-01 1:00:00.00000+00:00",
    "row_count": 123123,
    "distinct_count": 123123,
    "histo_col_type": ""
  }
]'

statement ok
CREATE TABLE y (
  u INT PRIMARY KEY,
  v INT REFERENCES x,
  INDEX (v),
  FAMILY "primary" (u, v)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM x WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4kIvdgZLkWIUKGQEmKoynTZXDiSlaxEEBEVRK1FZTEXKkzcM6Ef4V_YD-5R8yUAptT1MXbCt8YMBXp57zj1Xh7YNb3ijhKx9CCX70EjK3r98AbzjLG9FVfAGNFcaNgMKoRRnUFBNc6o4XMDE3E4WALYNBS9pW2nY0KrlPgxQobT6WMEFyLIchdFWyx4q6oJ3pOFMrte8LqgWslaE1zSvePEPBJ-nCpfXaYYTSHGWRfErUB8rhzVFTkSteVPTytGGijTyZ6I01UJpwZRDFZEl0WLd27G9P35X435sz1VfFHrAKudgeCLLcpxpb3mMyYymHANZUy0YYbKqODPLcA67mJS0UnycXTct_y_sa1GbvQwbUkbk2bjAM9d9hL-UDWdUafX1RlZbpfma9J9QEWNgqP8LAXSd4j7NCxQmOMgwZMGLJYa7Nq8EczqYohMKUZw9h3iVQXy9XM7QSf5QGU7hKk6zJIjiDDpy94Fv4SqJXgfJO_gBv4MphSANT2foJIpf4rfQkZyIooNp3tfR6QKhYGkMDspmGGcvH8Xf4zCDNAuyKM2iMIXJDQIA-LX_Nz-Lbn4iSvzCLR_c2aHMZNWua2X5cLMvDnhrf749xjecal4Qqi0frHPXe267nu164Hq-6_quax2BTaRFzTRhsq1Ng-cea78XSksTJKK3d2Yw67i5bqtq33jcZp7hnvB87p3P-7vfZv_Xcv4klvsJn841up0sHgvo1gS0_VtAN18K6HYkoO3ngP4FtyGlQV6uEhy9igfk5hQSfIkTHIc43b-RKT2k2_T16d48nu7taLp70_jt1TKIYpiurrIZ4PjNKaR4abDfwGWyeg0d_PgdTjDkcAHzBbJt20aK0Rq6bx8eGIL73e5-9-l-9wmYrJVuqKi1D2fnZ54PN2dzsOFsfov-DAAA__9aof_m


statement error pq: at or near "EOF": syntax error: the ENV flag can only be used with OPT
EXPLAIN (ENV) SELECT * FROM x WHERE b = 3

#
# Multiple Tables.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x, y WHERE b = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0lN9u2zYUxq_Dpzjwje3BcqQYBQoZAea6TKfNlQNJ6VoEAUFR1MpVJlOR8qQNA4o9gy_3GnuBPUqeZKCU2h6qLtjW-MIAD3_nz3f80Y4Dr3iphZI-LBV7VyrK3j5_BrzmLK1EkfESDNcGth2FUIwTyKihKdUczmFob4dzAMeBjOe0KgxsaVFxHzpUaKPfF3AOKs97MVoZ1aJCZrwmJWdqs-Eyo0YoqQmXNC149g8FPk61XF3FCY4gxkkShC9Avy-mrMxSIqThpaTF1NhSpFQ_EW2oEdoIpqdUE5UTIzatHMf78w_dr8fxXP3ZRvesnh4ED1We91faS-6rZEfTU4tsqBGMMFUUnNllTA-7GOa00Ly_uikr_l-qb4S0e-k2pG2TJ_0NnrjuA_VzVXJGtdFfbmTdaMM3pP0JNbECuvi_aICuYty6eY6WEV4kGJLFsxWG2yotBJvWMEInFIIweQrhOoHwarWaoJP0PtKdluswTqJFECZQk9t3vIHLKHi5iN7Ad_gNjCgs4uV4gk6C8Dl-DTVJichqGKVtHI3nCC1WVmDX2Q4z3bcPwm_xMoE4WSRBnATLGIbXCADgl_bbfgZ0-wPR4mc-8MGdHMJMFdVG6oEP1_tgxw_255tjvuTU8IxQM_BhcOZ6Tx3Xc1wPXM93Xd91B0ewtbSQzBCmKmkTPPe491uhjbJGIqa5tYMNjpNlVRT7xOM0-wz3Bc9m3tmsvft18n8lp48iuZ3w8VSjm-H8IYM21qDVJwbdfs6gTY9Bq48G_Ru3JbklL9YRDl6EHbkdQ4QvcITDJY73b2RED-62ea27tw-7u-l1dysav75cLYIQRuvLZAI4fDWGGK8s-xVcROuXUE-gge-_wRGGFM5hNkeO4zhISMlL50clJIxYqbQeI7jb_X63-3C3-wCaUQnNJ5H66_s3aW9-s6u_2-3uAaakNiUV0vhwenbq-XB9OgMHTmc36AjLRWF4qWFk_1TG6K8AAAD__xYpI_4=

#
# Same table twice should only show up once.
#

query T
EXPLAIN (OPT, ENV) SELECT * FROM x one, x two
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4kIvtgdLkFIUKGzkQVWZQpsrB5JStAgCgqKolatMpiLlyBsG9CPyuN_YD-xT8iUDpdT2MGXBttYPhnjvuefec3Uo14W3vNFCyQVEin1sFGUfXr0E3nFWtKIueQOGawPbAYVQhnMoqaEF1RzOYGKzkyWA60LJK9rWBra0bvkCBqjQRn-q4QxUVY3CaGtUDxWy5B1pOFObDZclNUJJTbikRc3LfyD4MlW0usxynEKG8zxOXoP-VHusKQsipOGNpLVnLBVp1C3RhhqhjWDao5qoihix6eW4wR-_63E9buDrRxs9YLV3EDxRVTXOtJc8xmRH056FbKgRjDBV15zZZXiHXUwqWms-zm6alv8X9o2Qdi_DhrRt8ny8wXPff4K_Ug1nVBv99UbWO234hvSvUBMrYIj_iwboMsO9m5coSnGYY8jDlysMN21RC-Z1MEUnFOIkfwHJOofkcrWao5PiITKconWS5WkYJzl05OYj38FFGr8J0_fwA34PUwphFs3m6CROXuF30JGCiLKDadHH0WyJULiyAofOdhhv3z5OvsdRDlke5nGWx1EGkysEAPBL_29_Dt3-SLT4mTsL8OeHMFN1u5HaWcDVPjjgnf35-hjfcGp4SahxFuCc-sEL1w9cPwA_WPj-wvedI7C1tJDMEKZaaQsC_7j3B6GNskYiZndjB3OOi2Vb1_vC4zJ7DfeEp8-C02d97tf5_5VcfBPJ_YTfTjW6niyfMujOGrT9m0G3jxl0N2LQ9otB_4Lbksoiz9cpjl8nA3I7gxSf4xQnEc72d2RKD-62db27t0-7ezfq7l40fnexCuMEpuuLfA44eTuDDK8s9js4T9dvoIMwAyX5fHgyt2qJXNd1kZCSN-5PSkiYskZpPUNwf_fb_d3n-7vPoBmV0MEV1WdK8utHUuZW9am7h1QlasMbDVP7yZihPwMAAP__SrEYaQ==

#
# Set a relevant session variable to a non-default value and ensure it shows up
# in the environment dump.
#

statement ok
SET reorder_joins_limit = 63

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkWJ0CGTkQVWZTpsrB5LStQgCgqKolatEpiLlWRsG9CPyK_uBfUq-ZKDUOR6mLtjW-MEAL8-9556jQ8eB17zRQkkfQsXeN4qydy-eA99xlreiKngDhmsD2wGFUIozKKihOdUczmFqb6crAMeBgpe0rQxsadVyHwao0EZ_qOAcVFmOwmhrVA8VsuA70nCm6prLghqhpCZc0rzixT8MULJvb7hqCt6QH5WQmlSiFgbO4evlaM_ZICRcX6UZTiDFWRbFL0F_qBasKXIipOGNpNXCWHbSqJ-INtQIbQTTC6qJKokRde-A4_3-mx63wPFc_VmiT1i9ePBoqspyfNLepbFJdjW9sJCaGsEIU1XFmfVv8WDftKSV5uPTTdPy_zK9FtL6MjikLcmzcYJnrvvI_FI1nFFt9JdbWXfa8Jr0n1ATK2Co_wsCdJXi_gGsUJjgIMOQBc_XGG7bvBJssYMZOqIQxdkZxJsM4qv1eo6O8k-V4RRu4jRLgijOYEdu3_MOLpPoVZC8he_wW5hRCNLweI6OovgFfgM7khNR7GCW93V0vEIoWFuBA7NdZrGnj-JvcZhBmgVZlGZRmML0GgEA_NL_29-Ebn8gWvzMJz6484cyU1VbSz3x4XpfHPCT_fnmEN9wanhBqJn4MDl1vTPH9RzXA9fzXdd33ckB2EZaSGYIU620DZ57yP1OaKNskIjpbu1ik8Nm2VbVvvGwzT7D_cDTpXe67O9-nf9fyfmTSO43fDrV6Ga6eiygnQ1o-7eAbj8X0G4koO2fAf0LbktKi7zYJDh6GQ_I7TEk-AInOA5xun8jM_qQbtvXp3v7eLq70XT3ovGby3UQxTDbXGZzwPHrY0jx2mK_gotk8wo6-P4bnGBo4RyWK-Q4joM0oxI6BPd3d_d3H-_vPgJTUpuGCml8OPF8uD5ZggMnyxv0RwAAAP__Bh4NJA==

# Make sure it shows up correctly even if it matches the cluster setting.
statement ok
SET CLUSTER SETTING sql.defaults.reorder_joins_limit = 63


query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U9Fu2zYUfQ6_4sIvdgbLkWK0CGTkwVWZTpsrB5LStQgCgqKolatEpiLlWRsG9CPyK_uBfUq-ZKDU2R6mNNjW-MGArs49556rcx0H3vBaCyV9CBT7UCvK3r98AXzLWdaIMuc1GK4NbHoUQglOIaeGZlRzOIexfTteADgO5LygTWlgQ8uG-9BDhTb6YwnnoIpiEEYbozqokDnfkpozVVVc5tQIJTXhkmYlz79AoGTXXnNV57wmPykhNSlFJQycw_P5YM9ZbyRYXSUpjiHBaRpGr0B_LGeszjMipOG1pOXMWHVSq5-JNtQIbQTTM6qJKogRVbcBx_vjdz28Asdz9YNCn7F6tt_RWBXFMNNuS19kGt7B-Pl8mPTsQUZrVs-saEWNYISpsuTMfpHZ_oOMC1pqPkxt6ob_F_ZKSLvpfufaijwbFnjmuo_wF6rmjGqjv97IutWGV6QLhSbWQF__FwLoKsHdSS1QEONliiFdvlhhuG2yUrDZFiboiEIYpWcQrVOIrlarKTrKPlf6p2AdJWm8DKMUtuT2A2_hMg5fL-N38D1-BxMKyyQ4nqKjMHqJ38KWZETkW5hkXR0dLxBarqzBXtkOM9vJh9F3OEghSZdpmKRhkMD4GgEA_Nr929-Ibn4kWvzCRz64032ZqbKppB75cL0r9vjR7vnmEF9zanhOqBn5MDp1vTPH9RzXA9fzXdd33dEB2B6JkMwQphppGzz3UPu90EbZIBHT3trBRofNsinLXeNhmz3sHeHp3Dudd-9-m_5fy9mTWO4mfDrX6Ga8eCygrQ1o84-Abh4KaDsQ0OavgP4NtyGFRV6sYxy-inrk5hhifIFjHAU42d3IhO7Tbfu6dG8eT3c7mO7ONH57uVqGEUzWl-kUcPTmGBK8sthv4CJev4YWfvgWxxgaOIf5AjmO4yDNqIQWwf3d3f3dp_u7T8CU1KamQhofTjwfrk_m4MDJ_Ab9GQAA__9BYCeO

statement ok
SET enable_zigzag_join = true

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYUvg6f4sA3dgbLkWK0CGTkwlWZTpsrB5LStQgCgqKolKtEpiLlWRkG9CHyKnuBPUqeZKDUOR6mNNjW-sKAjr4ffkcfHQfe8FoLJX0IFPtQK8rev3wBfMtZ1ogy5zUYrg1sehRCCU4hp4ZmVHM4hbF9O14AOA7kvKBNaWBDy4b70EOFNvpjCaegimIQRhujOiiXNCs5uRXXt_Sa_KyEtCw5SFJF0XGEzPmW1JypquIyp0YoqUmvlH_BVMmOXnNV57zuzDQpRSUMnMLz-SDnpA8frC6SFMeQ4DQNo1egP5YzVucZEdLwWtJyZroctfqFaEON0EYwPaOaqIIYUXVbc7w_ftfDa3M8Vz9q9BmrZw97HauiGFbabfaLSsM7GD-fD4uePKpow-qZNa2oEYwwVZac2S8ye_gg44KWmg9Lm7rh_0W9EtJuut-5tibPhg2eue4T-oWqOaPa6K93ZN1qwyvSlUITG6Cf_wsDdJHg7houUBDjZYohXb5YYbhpslKw2RYm6IBCGKUnEK1TiC5Wqyk6yD5P-qdgHSVpvAyjFLbk5gNv4TwOXy_jd_AjfgcTCsskOJyigzB6id_ClmRE5FuYZN0cHS4QWq5swN7ZHma2sw-jH3CQQpIu0zBJwyCB8SUCAPi1-7e_Ed1cEy1u-cgHd_owZqpsKqlHPlzuhj1-tHu-2sfXnBqeE2pGPoyOXe_EcT3H9cD1fNf1XXe0B7aXREhmCFONtATP3fd-L7RRtkjEtDf2YKN9smzKckfcp9mLvRM8nnvH8-7db9P_Gzn7JpG7E3671OhqvHiqoK0taPOPgm4eK2g7UNDmr4L-DbchhUWerWMcvop65OYQYnyGYxwFONndkQl9aLflde3ePN3udrDdXWj89ny1DCOYrM_TKeDozSEkeGWx38FZvH4NLfz0PY4xNHAK8wVyHMdBmlEJLYL7u7v7u0_3d5-AKalNTYU0Phx5PlwezcGBo_kV-jMAAP__nkE5Cw==

statement ok
SET optimizer_use_histograms = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN1u2zYUvg6f4sA3dgbLkWK0CGTkwnWZTpsrB5LStQgCgqKolKtEpiTl2RkG9CHyKnuBPUqeZKDUOR6mNNjW-sKAjr7vO3_fkefBG66NUDKEhWIftKLs_csXwDec5Y2oCq7BcmNh3aEQSnEGBbU0p4bDKQzd2-EMwPOg4CVtKgtrWjU8hA4qjDUfKzgFVZa9MNpY1UK5pHnFya24vqXX5GclpGPJXpIqy5YjZME3RHOm6prLglqhpCGdUvGFpEq2dHVjRS1uuSaN4eS9MFZda1qbp5maK11w3ZZpSCVqYeEUnk97OSfd2BbLizTDCaQ4y6L4FZiP1YTpIidCWq4lrSa2nYBWvxBjqRXGCmYm1BBVEivqdt5e8Mfvpn_gXuCbRxN9xprJw0aGqiz7lXY7-aJS_wyGz6f9oiePKrpmzcQlrakVjDBVVZy5XU4eVjksaWV4v7TVDf8v6rWQbtLdzN3Wh8_6Ezzz_Sf0S6U5o8aar1ey2RrLa9KawhDXQBf_FwnQRYrbA56hRYLnGYZs_mKJ4abJK8EmGxihAwpRnJ1AvMogvlgux-gg_xzpnharOM2SeRRnsCE3H_gWzpPo9Tx5Bz_idzCiME8Xh2N0EMUv8VvYkJyIYgOjvI2jwxlC86VrsMvsipns0kfxD3iRQZrNsyjNokUKw0sEAPBr--9-A7q-Jkbc8kEI_vghzFTV1NIMQrjcBTv8YPd8tY_XnFpeEGoHIQyO_eDE8wPPD8APQt8PfX-wB3ZHIiSzhKlGOkLg7-duvxTOSMRub1xhg32ybKpqR9ynucPeCR5Pg-Np--638f9tOf8mLbcVfruu0dVw9pRBt86gzT8Mun7MoNsegzZ_GfRvuDUpHfJsleDoVdwh14eQ4DOc4HiB092NjOiDux2vdff6aXdve93dNo3fni_nUQyj1Xk2Bhy_OYQULx32OzhLVq9hCz99jxMMDZzCdIY8z_OQYVTCFsH93d393af7u0_AlDRWUyFtCEdBCJdHU_DgaHqF_gwAAP__4jFNVg==

statement ok
SET optimizer_use_multicol_stats = false

query T
EXPLAIN (OPT, ENV) SELECT * FROM y WHERE u = 3
----
https://cockroachdb.github.io/text/decode.html#eJy0VN9u27YXvo6e4sA3dn6wHClGi0BGLlyX6U-bKweS0rUIAoKiqJQrRaYi5dkZBvQh8ip7gT1KnmQg1TkepjTrtvrCgI6-7zv_viPfhzes0VzJCBaKfmgUoe9fvgC2YbRouShZA4ZpA-sO5XkZyqEkhhREMziFoX07nAH4PpSsIq0wsCaiZRF0UK6N_ijgFFRV9cJIa5SDMkkKwfAtv74l1_hHxaVlyV6SqirH4bJkG9wwquqayZIYrqTGnVL5haRKOrq6Mbzmt6zBrWb4PddGXTek1l_LrFthOFUCa0PM32A3TDUla1yTGgtecwOn8Hzayznphr5YXmQ5SiFDeR4nr0B_FBPalAXm0rBGEjExbn6N-smVwbXhVE-IxqrChtduW37426-6f11-GOhHE33G6snDPoeqqvqVdhv9olL_DIbPp_2iJ48quplPbNKaGE4xVUIwap0weTDCsCJCs35p07Tsn6jXXNpJdzO3Wx8-60_wLAie0K9UwyjRRv93JeutNqzGzhQa2wa6-Fck8C4y5M5_5i1SNM8R5PMXSwQ3bSE4nWxg5B0QiJP8BJJVDsnFcjn2DorPke5psUqyPJ3HSQ4bfPOBbeE8jV_P03fwPXoHIwLzbHE49g7i5CV6CxtcYF5uYFS4uHc487z50jbYZbbFTHbp4-Q7tMghy-d5nOXxIoPhpQcA8LP7t78BWV9jzW_ZIIJg_BCmSrS11IMILnfBDj_YPV_t4xtGDCsxMYMIBsdBeOIHoR-EEIRREERBMNgD2yPhkhpMVSstIQz2c7vvjDUSNtsbW9hgnyxbIXbEfZo97J3g8TQ8nrp3v4z_bcvFN2nZVfjtuvauhrOnDLq1Bm3_YtD1Ywbd9hi0_cOgf8KtcWWRZ6sUxa-SDrk-hBSdoRQlC5TtbmREHtxtec7d66fdve11t2savT1fzuMERqvzfAwoeXMIGVpa7P_gLF29hi388H-UImjhFKYzz_d939OUSNh6cH93d3_36f7uE1AltWkIlyaCozCCy6Mp-HA0vfJ-DwAA__8iS2NX

statement ok
RESET reorder_joins_limit

statement ok
RESET enable_zigzag_join

statement ok
RESET optimizer_use_histograms

statement ok
RESET optimizer_use_multicol_stats

#
# Test sequences.
#

statement ok
CREATE SEQUENCE seq

query T
EXPLAIN (OPT, ENV) SELECT * FROM seq
----
https://cockroachdb.github.io/text/decode.html#eJysk8-O0zAQxu95irkVEI76h_5hqx5KMKhSm12atNqb5ToTYXBs6nGW5cF4AZ4MuUHsJbsIxC3KfPP7PN_YjMERPWlnryBz6rN3Un18-wbwHtWp1aZCDwEpwF2nSpKCl1DJIE-SEFYwiNXBEoAxqLCWrQlwJ02LV9BJNQU6G1iBq-temWyDu0i1rfBeeFSuadBWMmhnSaCVJ4PVEwBnL-0ena_Qi09OWxJGNzrACmaT3p5FN0i2PRQl30PBy3KTvwc6m1T56iS0DeitNGmI7sK7r4KCDJqCVpRKEq4WQTeXBNjox3fqj4CNhvSo0S8tpQ8ZDVxd95N-p_QkqT-DwWzSD108SozDUhpNGxm0EsoZgypuJH1YyKCWhrAfHXyL_0JvtI1Jd5lTNJn2G0yHwz_wa-dRSQr0_45M3yhgIy6XgkQcoPv_FwbJoeCXJ7VMsj1flxwK_uHA84zDl_ZktEoJz7Db5Mf19sBhBLv1bff5ejyeTObj4WS2mL6az6eL4Rw2ebbnO56XMIKiXO9LGC2ThN_ebNebHJ5d35QvgefH51DwLc9KeAHv9tc7IDwvE8YYSwjPLVqFjDCuIFaSnwEAAP__P3dRzw==

#
# Test views.
#

statement ok
CREATE VIEW v AS SELECT a, b, u, v FROM x, y WHERE b = 3

query T
EXPLAIN (OPT, ENV) SELECT * FROM v
----
https://cockroachdb.github.io/text/decode.html#eJy0VNFu2zYUfQ6_4sIvtgfJkWK0CGQEmOoynTZXDiQlbREEBCVRK1eZTEVKszcMKPYNftxv7Af2KfmSgVLiuKvSYFvrBwO6PPecey_PpW3DBasUl8KDuczeVZJmb58_A7ZmWVrzMmcVaKY0NB0KoRgnkFNNU6oYnMDQnA5nALYNOStoXWpoaFkzDzooV1q9L-EEZFH0wmitZQvlImdrUrFMrlZM5FRzKRRhgqYlyz9DIEWbXjFZ5awiP0kuFCn5ims4gafT3pzjrpH54jxOcAQxTpIgfAHqfTnJqjwlXGhWCVpOtFEnlfyZKE01V5pnakIVkQXRfNVOwHb_-lP1j8B2HfWg0C1WTe5nNJRF0c-0m9JnmfpnMHw67Sc9fpDRNKsmRnRFNc9IJsuSZeZGJvcXMixoqVg_ta5q9l_YV1yYSXczV0bkSb_AE8d5hL-QFcuo0urLlaw2SrMVaU2hiGmgi_8LAXQe43alZmgeYT_BkPjPFhiu67Tk2WQNI3RAIQiTYwiXCYTni4WFDtLbSPc1X4ZxEvlBmMCaXL9jGziLgpd-9AZ-wG9gRMGP52MLHQThc_wa1iQlPF_DKG3jaDxDyF-YBjtlU8xkJx-E3-N5AnHiJ0GcBPMYhpcIAODX9t_8BrT5kSj-Cxt44Fj34UyW9UqogQeXu2CHH-y-r_bxFaOa5YTqgQeDI8c9th3XdlxwXM9xPMcZ7IHNknCRaZLJWpgE19nXfsuVlsZIRG-uTWGD_WRRl-UucT_NLPaO8GjqHk3bs9-s_9ty-lVabiv8el2jq-HsMYNujEHrTwzaPGTQTY9B6zuDfoRrSGGQp8sIBy_CDtmMIcKnOMLhHMe7HRnRe3ebvNbdzePu3vS6u7_piwC_uhNs2qU0a2ihg9p0i8bgxxDjhWGjFqQW1BY0cBotX368UNY_Knj1HY4wpHAC0xlC-PXZwg9CGC3PEgtweDG-I_2m42pmyLZtG3EhWGWbdx1GWSWVGiO42f5xs_1ws_0AKqMCNp9E1t_e7r45-d1c8c12ewvIpFC6olxoDw6PDl0PLg-nYMPh9ArtwQpealYpGJnHa4z-DgAA__-oRWwS

#
# Test tables in user-defined schemas.
#

statement ok
CREATE SCHEMA s;
CREATE TABLE s.t (a int primary key)

query T
EXPLAIN (OPT, ENV) SELECT * FROM s.t;
----
https://cockroachdb.github.io/text/decode.html#eJysk8Fu1DAQhs_1U8wtLWqirapWq672kAaDAml2lXgrKoQsbzIRpolNPd7SPhgvwJMhbxC9pEUgrvY_3z_zjx3HcI2OtDUXkNnm1lnVfH59CfiAzXan-xYdeCQP96OKsZoLaJVXW0UIS4jCbbQAiGNosVO73sO96nd4AaNUk6e7HpZgu25Spnbe7qXatPggHTZ2GNC0ymtrSKJR2x7bFwDW7MsdWteik1-sNiR7PWgPSzg_nayZj4NkxaYWvIKaC5GXb4Hu-qRx7VZq49EZ1Sc-uEtnv0nyymvyuqFEkbSd9HrYJxCf_PhO0xHEJzN61uiXlpKnjCLbddOk3ym9SJrOIDo_nYbOnyWGYSkJpoPyupGN7XtswkaSp4VEneoJp9He7fBf6IM2IekxcwomZ9MGZ7PZH_idddgo8vT_WqZH8jjI_aMgGQYYz__CgG1qvv9SC5ZVPBUcRHpZcKDEwyE7UJCXYg7lSkC5KYpjdpCtylpUaV4K8PLrLT7Cusqv0uoG3vMbOFSQ1tkRO1owlhah6xEXHJLAzMt3PBNQi1TktcizGqKPn6IFY_zDukjzEg5Xa3EMvLw-gpoXQfsK3lSrq9DRgsVxHDNqlAHPfgYAAP__2Y1WZQ==

#
# Test default_transaction_quality_of_service settings.
#

statement ok
SET default_transaction_quality_of_service=background

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xewcA6FgI0gQJPAiTYUigOEGtWJ0R4yoUcqGImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wFXAfzEAOaL-_fAT2SqTrraoogxAK7IZVl66KEGgUrZIIFTNLXySWAUlBTg50T2KHr6AKG6HCmJaJnNGKD19sOnZUnHRrNFHfWJFCF5uE-hs7Xo7BI953DODAtC28dLCA0zWgaOwl91PqaHnUkE9qWfI2pnzV5rBzVbwCC78cjhVhT1F-D9aydba3AAs5ORmfOBznXy7t1WXyCdVGWN6sPwFuXm1hX2nqh6NHlktp1DN80C4plsYZz5ORDbNtbVfMf33lcq5rP-NWiX1nOXxxNQtOMk35bepM07mBydjIOPX-VmC7LeSptUazRJjhH_UbkLw8yadAxjaMldvQv9Nb6ZHpwzqnkdLzgdDb7A78JkQyy8P_7ZX5ioVb3S8E6XWA4_4uCrPh8u7y6WcHRx9vyGIrVZgqbq-VdsYaj-fQyU0qprB_gDA77_WH_fNg_w9H8eJr9DAAA___03lZf

statement ok
SET default_transaction_quality_of_service=critical

query T
EXPLAIN (OPT, ENV) VALUES(1);
----
https://cockroachdb.github.io/text/decode.html#eJyskkFu2zAQRfc6xexkA6FgI0gQJPAiTYUigOEGtWJ0R4ypUcuWImHOyE12OYSv0gv0KD5JQaloNkqKFt1Sf94XH0cp2FBkG_wl3ATzNQY0n9--AXogs-2sqymCEAvsh1SWrcsKahTcIhMsIE9f8ysApaCmBjsnsEfX0SUM0eFMS0TPaMQGr3cdOiuPOjSaKe6tSSATrViDbhQV6VPnMA5Ey8I7BwsITTOaxk5CH7W-pgcdyYS2JV9jamdNHreO6lcAwffjkUKsKeovwXrWzrZWYAHnp6MzF4Oam-X9uio_wLqsqtvVO-CdK0yst9p6oejRFZLadQzfNAuKZbGGC-RkQ2zbO1XzH995XKqaz_jFol9ZLp4d5aFpxkm_Lb1KGneQn5-OQy9eJKbLcpFKWxRrtAnOUb8PxfOD5A06pnG0xI7-hd5an0wPzjmVnI0XnM1mf-A3IZJBFv5_v8yPLNTqfilYpwsM539RkJUf75bXtyuYvL-rTqBcbaawuV7el2uYzKdXmVJKZf0AZ3A8HI6Hp-PhCSbzk2n2MwAA__-yYVWK

#
# Test recursive table references from foreign keys.
#

statement ok
CREATE TABLE z (
  pk INT PRIMARY KEY,
  ref INT,
  CONSTRAINT fk FOREIGN KEY (ref) REFERENCES y(u),
  FAMILY "primary" (pk, ref)
)

query T
EXPLAIN (OPT, ENV) SELECT * FROM z;
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYYvY6e4oNv7AyWISdoEdjIhesyhTZXDiSlaFEUBEVRLWeKdEhKszzssfYCe7KBUue4qJzsL74woE_nO4fn6ND34R3This5g6WiG60I_fL6FbAdo1nFRc40WGYs1B3K8xKUQk4syYhhcA1D93Y4B_B9yFlBKmGhJqJiM-ig3QxbTaQh1HIl8X1FBLcNVgU2TNecOiKqueWUiF4qzT5XguiOkRtr7gVcgyqKXjSprGqhXOZshzWjqiyZzIlTN5hJkgmWP0KgZLuumdI50_hnxaXBgpfcwjW8vOzdueqiWa7ukhTFkKA0DaM3YO7FhOo8w1xapiURE-vUsVa_YGOJ5cZyaibEuDQsL9tM_ekfv5v-UP1pYE4KfcWayUNGQ1UU_UyHlB5l6s9g-PKyn_TqJKMzayZOtCSWU0yVEKztw-ThgwwLIgzrp7a6Yv-GveTSJd1lbpzIi36BF0HwBH-hNKPEWPP_Hdk0xrISt6Uw2Bno5v9AwLtLUHtJ594yRosUQbp4tUKwrTLB6WQHI--MQBilVxCtU4juVquxd5Z9nXRPy3WUpPEijFLY4e2GNXAbh28X8Qf4CX2AEYFFsjwfe2dh9Bq9hx3OMM93MMrauXc-97zFyhnslN1hJgf5MPoRLVNI0kUaJmm4TGD40QMA-LX9d78BqT9jw_dsMINg_DCmSlSlNIMZfDwMO_zg8PzpGK8ZsSzHxA5mMLgIpld-MPWDKQTTWRDMgmBwBHaXhEtqMVWVdAvT4Fj7CzdWuSJh22zdwQbHy7IS4rB4vOYu9oHw4nJ6cdm--238Xy1nz2K5PeHzufY-DedPFbRxBa2-K2h9qqBNT0Grvwr6Da7GhUPerGMUvok6ZH0OMbpBMYqWKDnckRF5aLfba9tdP93uprfdf8P03pnebr5zrVlxyve-x_d202O82HxrWbOiz3Qzqh43tz9tDr2_XS3CCEbr23QMKHp3DglaOewPcBOv38J-7vm-73uGEgl7788AAAD__zy3crc=

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYYvY6e4oNv7AyWISdoEdjIhesyhTZXDiSlaFEUBEVRLWeKdEhKszLssfYCe7KBUme7qJzsL74woE_nO4fn6ND34R3This5g6WiG60I_fL6FbAdo1nFRc40WGYs1B3K8xKUQk4syYhhcA1D93Y4B_B9yFlBKmGhJqJiM-ig3QxbTaQh1HIl8X1FBLcNVgU2TNecOiKqueWUiF4qzT5XguiOkRtr7gVcgyqKXjSprGqhXOZshzWjqiyZzIlTN5hJkgmWP0KgZLuumdI50_hnxaXBgpfcwjW8vOzdueqiWa7ukhTFkKA0DaM3YO7FhOo8w1xapiURE-vUsVa_YGOJ5cZyaibEuDQsL9tM_ekfv5v-UP1pYE4KfcWaySGjoSqKfqZ9So8y9WcwfHnZT3p1ktGZNRMnWhLLKaZKCNb2YXL4IMOCCMP6qa2u2L9hL7l0SXeZGyfyol_gRRA8wV8ozSgx1vx_RzaNsazEbSkMdga6-T8Q8O4S1F7SubeM0SJFkC5erRBsq0xwOtnByDsjEEbpFUTrFKK71WrsnWVfJ93Tch0labwIoxR2eLthDdzG4dtF_AF-Qh9gRGCRLM_H3lkYvUbvYYczzPMdjLJ27p3PPW-xcgY7ZXeYyV4-jH5EyxSSdJGGSRouExh-9AAAfm3_3W9A6s_Y8Ac2mEEwPoypElUpzWAGH_fDDj_YP386xmtGLMsxsYMZDC6C6ZUfTP1gCsF0FgSzIBgcgd0l4ZJaTFUl3cI0ONb-wo1VrkjYNlt3sMHxsqyE2C8er7mLvSe8uJxeXLbvfhv_V8vZs1huT_h8rr1Pw_lTBW1cQavvClqfKmjTU9Dqr4J-g6tx4ZA36xiFb6IOWZ9DjG5QjKIlSvZ3ZEQO7XZ7bbvrp9vd9Lb7b5h-cKa3m-9ca1ac8v3Q43u76TFebL61rFnRZ7oZVY-bezhtDr2_XS3CCEbr23QMKHp3DglaOewPcBOv30Iz93zf9z1DiYTG-zMAAP__PKZytQ==

query T
EXPLAIN (OPT, ENV) SELECT * FROM x;
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYYvY6e4oNv7AyWISdoEdjIhesyhTZXDiSlaFEUBEVRLWeadEhKkzLssfYCe7KBUme7qJzsL74woE_nO4fn6ND34R3This5g6WiG60I_fL6FbCa0azkImcaLDMWqg7leQlKISeWZMQwuIahezucA_g-5KwgpbBQEVGyGXTQboatJtIQarmS-L4kgtsGqwIbpitOHRHV3HJKRC-VZp9LQXTHyI019wKuQRVFL5qUVrVQLnNWY82o2m6ZzIlTN5hJkgmWP0KgZLuumdI50_hnxaXBgm-5hWt4edm7c9VFs1zdJSmKIUFpGkZvwNyLCdV5hrm0TEsiJtapY61-wcYSy43l1EyIcWlYvm0z9ad__G76Q_WngTkp9BVrJoeMhqoo-pn2KT3K1J_B8OVlP-nVSUZn1kyc6JZYTjFVQrC2D5PDBxkWRBjWT211yf4N-5ZLl3SXuXEiL_oFXgTBE_yF0owSY83_d2TTGMu2uC2Fwc5AN_8HAt5dgtpLOveWMVqkCNLFqxWCXZkJTic1jLwzAmGUXkG0TiG6W63G3ln2ddI9LddRksaLMEqhxrsNa-A2Dt8u4g_wE_oAIwKLZHk-9s7C6DV6DzXOMM9rGGXt3Dufe95i5Qx2yu4wk718GP2Ilikk6SINkzRcJjD86AEA_Nr-u9-AVJ-x4Q9sMINgfBhTJcqtNIMZfNwPO_xg__zpGK8ZsSzHxA5mMLgIpld-MPWDKQTTWRDMgmBwBHaXhEtqMVWldAvT4Fj7CzdWuSJh2-zcwQbHy7IUYr94vOYu9p7w4nJ6cdm--238Xy1nz2K5PeHzufY-DedPFbRxBS2_K2h1qqBNT0HLvwr6Da7ChUPerGMUvok6ZHUOMbpBMYqWKNnfkRE5tNvtte2unm5309vuv2H6wZnebb5zrVlxyvdDj-_dpsd4sfnWsmZFn-lmVD5u7uG0OfT-drUIIxitb9MxoOjdOSRo5bA_wE28fgv13PN93_cMJRJq788AAAD__zyVcrM=

# A foreign key cycle shouldn't cause infinite recursion.
statement ok
ALTER TABLE y ADD CONSTRAINT fk FOREIGN KEY (v) REFERENCES z (pk);

query T
EXPLAIN (OPT, ENV) SELECT * FROM y;
----
https://cockroachdb.github.io/text/decode.html#eJy0U91u2zYYvY6e4oNv7AyWISdoEdjIhesyhTZXDiSlaFEUBEVRLWeKdEhKszzssfYCe7KBUut4qJzsL74wIOp85_Acnc_34R3This5g6WiG60I_fL6FbAdo1nFRc40WGYs1B3K8xKUQk4syYhhcA1D93Y4B_B9yFlBKmGhJqJiM-ig3Rm2mkhDqOVK4vuKCG4brApsmK45dURUc8spEb1Umn2uBNEdIzfW3Au4BlUUvWhSWdVCuczZDmtGVVkymROnbjCTJBMsf4RAyXZcM6VzpvHPikuDBS-5hWt4edk7c9VFs1zdJSmKIUFpGkZvwNyLCdV5hrm0TEsiJtapY61-wcYSy43l1EyIcWlYXraZ-tM_fjf9ofrTwJwU-oo1k4eMhqoo-pkOKT3K1J_B8OVlP-nVSUZn1kycaEksp5gqIVjbh8nDBxkWRBjWT211xf4Ne8mlS7rL3DiRF_0CL4LgCf5CaUaJseb_u7JpjGUlbkthsDPQnf8DAe8uQe2Szr1ljBYpgnTxaoVgW2WC08kORt4ZgTBKryBapxDdrVZj7yz7etI9LddRksaLMEphh7cb1sBtHL5dxB_gJ_QBRgQWyfJ87J2F0Wv0HnY4wzzfwShrz73zuectVs5gp-wuMznIh9GPaJlCki7SMEnDZQLDjx4AwK_tv_sNSP0ZG75ngxkE44djqkRVSjOYwcfDYYcfHJ4_HeM1I5blmNjBDAYXwfTKD6Z-MIVgOguCWRAMjsBuSbikFlNVSTcwDY61v3BjlSsSts3WXWxwPCwrIQ6Dx2NusQ-EF5fTi8v23W_j_2o5exbL7Q2fz7X3aTh_qqB7V9Dt5ruGalac6ui-p6PbzbeSHgGLDdysYxS-iTqQZsU5xOgGxShaouTbFZpR9XiL970t_hvmGmeu-s5bfcpZ0-Os6jHW4BoXDvkXe3Wfud2IPJFK79h-tN08rLzTa1e-fnrlm9Nhofe3q0UYwWh9m44BRe_OIUErh_0BbuL1W2jmnu_7vmcokdB4fwYAAP__YUiCeQ==

# Check that we remove histograms from statistics correctly.

statement ok
CREATE TABLE b (
  b BOOL NOT NULL,
  INDEX (b)
)

statement ok
ALTER TABLE b INJECT STATISTICS '[
      {
          "avg_size": 1,
          "columns": [
              "b"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 2,
          "histo_buckets": [
              {
                  "distinct_range": 0,
                  "num_eq": 1000,
                  "num_range": 0,
                  "upper_bound": "false"
              },
              {
                  "distinct_range": 0,
                  "num_eq": 100,
                  "num_range": 0,
                  "upper_bound": "true"
              }
          ],
          "histo_col_type": "BOOL",
          "histo_version": 2,
          "name": "__auto__",
          "null_count": 0,
          "row_count": 1100
      },
      {
          "avg_size": 0,
          "columns": [
              "rowid"
          ],
          "created_at": "2022-12-02 18:34:29.574932",
          "distinct_count": 0,
          "histo_col_type": "",
          "name": "__auto__",
          "null_count": 0,
          "row_count": 0
      }
]'

query T
EXPLAIN (OPT, ENV) SELECT * FROM b
----
https://cockroachdb.github.io/text/decode.html#eJy8lN9u2zYUxq_DpzjwjZ3BEmSl6VIbuVAcddCmyoHFBC2KgqAoquVKkQlJpfGGPdZeYE82UGodD1CzP9jmCwP-zne-c_Qj5SCAG26s0GoJa80-Gk3Zh8sL4A-cVZ2QNTfguHVwP7gQKlMMNXW0opbDOUx9dboCCAKoeUM76eCeyo4vYbAOGnGGKkuZE1qRu45K4XZEN8Rycy-YD2JGOMGoHI0y_H0nqRkShXX2TsI56KYZddPO6d4qVM0fiOFMty1XNfXTLeGKVpLXTwRo1bcbrk3NDflRC2WJFK1wcA7PT0Z7zgY06_y6xOkWyhTjrPgO7J0MmakrIpTjRlEZOj-dGP2JWEedsE4wG1LraTjR9kyDxW-_2nGowSKyXx302WvDR0ZT3TTjSXtKTyaNM5g-PxkPPftqon9YG_qhLXWCEaal5P19CB8PZNpQafl4tDMd_yfprVCe9MDc-iGn4wNOo-hP8httOKPW2X9vZbuzjrekvxSW-AcY9L8xAF2Xaf-SrtB6myY4BZxc5CncdpUULKxgho4quNhscig2GIrrPJ-jI6M_iRqyAp_16k1WZr7piwMu05fJdY6hU-Ku69mJenY8R0frTVHibZIVGCpy-5Hv4GqbvUq2b-CH9A3MhtykXHtvVlymr6EiFRH1A8yqXkfHK4SS3PMYFvW7h_tts-L7dI2hxAnOSpytS5i-RQAAP_ff_jOh9--JFT_xyRIW80eZadm1yk6W8HYv9oVqsv_97tBvOHW8JtRNljCJozgOFnEQxbA4W548W8YvwtNvn704iScHPf7VEoo5wnSnfF98UPwgrNP-8hG3u_XbTQ5bFW17jfTnTMgfap2U-8jooOD_KL7oi0UU9ZVf5k8Qif4Kkf6Y_kMq0f9H5TMS9G66Qih9fZUnWQGzzRWeQ1rcHEOZ5v5CfQMvt5tXUK1QEAQBsowqqNDvAQAA__8WlBAF
